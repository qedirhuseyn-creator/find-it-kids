<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1" />
  <title>Find It Game (Kids)</title>
  <style>
    :root{
      --bg1:#bff0ff;
      --bg2:#b9f7c6;
      --card:rgba(255,255,255,.85);
      --shadow:0 10px 30px rgba(0,0,0,.12);
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      min-height:100vh;
      overflow:hidden;
      background:
        radial-gradient(1200px 700px at 30% 20%, var(--bg1), transparent 60%),
        radial-gradient(1200px 700px at 70% 80%, var(--bg2), transparent 60%),
        linear-gradient(#dff9ff, #e8ffe9);
      user-select:none;
      touch-action:manipulation;
    }

    .hud{
      position:fixed;
      top:12px; left:12px; right:12px;
      display:flex;
      gap:10px;
      align-items:center;
      justify-content:space-between;
      z-index:5;
    }
    .bubble{
      display:flex;
      align-items:center;
      gap:10px;
      padding:10px 14px;
      background:var(--card);
      border-radius:16px;
      box-shadow:var(--shadow);
      backdrop-filter: blur(6px);
      max-width:72%;
      min-height:44px;
    }
    .flag{
      font-size:22px;
      line-height:1;
    }
    .score{
      padding:10px 14px;
      background:rgba(255,255,255,.75);
      border-radius:16px;
      box-shadow:var(--shadow);
      display:flex;
      align-items:center;
      gap:10px;
      font-weight:800;
      min-height:44px;
    }
    .star{
      width:26px; height:26px;
      filter: drop-shadow(0 6px 10px rgba(0,0,0,.18));
    }

    .hint{
      position:fixed;
      bottom:14px; left:12px; right:12px;
      display:flex;
      gap:10px;
      justify-content:center;
      flex-wrap:wrap;
      z-index:5;
    }
    .btn{
      border:none;
      padding:10px 14px;
      border-radius:14px;
      box-shadow:var(--shadow);
      background:rgba(255,255,255,.78);
      font-weight:700;
      cursor:pointer;
    }
    .btn.primary{
      background: rgba(0,0,0,.78);
      color:#fff;
    }
    .toast{
      position:fixed;
      left:50%;
      top:50%;
      transform:translate(-50%,-50%);
      padding:14px 16px;
      border-radius:16px;
      background:rgba(0,0,0,.65);
      color:#fff;
      font-weight:800;
      opacity:0;
      pointer-events:none;
      transition:opacity .2s ease;
      z-index:10;
      text-align:center;
      white-space:nowrap;
    }
    .toast.show{ opacity:1; }

    canvas#fx{
      position:fixed;
      inset:0;
      pointer-events:none;
      z-index:9;
    }

    .screen{
      position:absolute;
      inset:0;
      display:none;
    }
    .screen.active{ display:block; }

    .setupWrap{
      position:absolute;
      inset:0;
      display:grid;
      place-items:center;
      padding:18px;
    }
    .setupCard{
      width:min(520px, 96vw);
      background:rgba(255,255,255,.80);
      border-radius:22px;
      box-shadow: var(--shadow);
      padding:16px;
      backdrop-filter: blur(8px);
    }
    .setupTitle{
      font-size:20px;
      font-weight:900;
      margin:0 0 6px 0;
    }
    .setupNote{
      opacity:.7;
      font-size:13px;
      margin:0 0 12px 0;
    }
    .setupRow{
      display:flex;
      gap:12px;
      align-items:center;
      margin:10px 0;
      flex-wrap:wrap;
    }
    .input{
      flex:1 1 220px;
      padding:12px 12px;
      border-radius:14px;
      border:1px solid rgba(0,0,0,.10);
      background:rgba(255,255,255,.9);
      font-size:16px;
      outline:none;
    }
    .select{
      padding:12px 12px;
      border-radius:14px;
      border:1px solid rgba(0,0,0,.10);
      background:rgba(255,255,255,.9);
      font-size:16px;
      outline:none;
    }
    .avatarBox{
      width:86px;
      height:86px;
      border-radius:999px;
      overflow:hidden;
      background:rgba(0,0,0,.06);
      box-shadow: 0 10px 22px rgba(0,0,0,.12);
      flex:0 0 auto;
      display:grid;
      place-items:center;
    }
    .avatarBox img{
      width:100%;
      height:100%;
      object-fit:cover;
      display:block;
    }
    .avatarFallback{
      font-size:30px;
      opacity:.55;
    }

    .game{
      position:absolute;
      inset:0;
      padding-top:70px;
    }
    .field{
      position:absolute;
      inset:0;
      display:grid;
      place-items:center;
    }
    .arena{
      position:relative;
      width:min(900px, 96vw);
      height:min(540px, 74vh);
    }
    .tile{
      position:absolute;
      display:grid;
      place-items:center;
      width: clamp(92px, 18vw, 150px);
      height: clamp(92px, 18vw, 150px);
      border-radius:24px;
      background: rgba(255,255,255,.70);
      backdrop-filter: blur(5px);
      box-shadow: 0 14px 28px rgba(0,0,0,.18);
      cursor:pointer;
      transition: transform .12s ease;
    }
    .tile:active{ transform: scale(.96); }
    .tile .big{
      font-size: clamp(52px, 10vw, 92px);
      font-weight: 900;
      line-height:1;
      filter: drop-shadow(0 10px 18px rgba(0,0,0,.12));
    }

    .kidTag{
      display:flex;
      align-items:center;
      gap:10px;
      margin-left:auto;
    }
    .kidMini{
      width:34px; height:34px;
      border-radius:999px;
      overflow:hidden;
      background:rgba(0,0,0,.06);
      box-shadow: 0 6px 14px rgba(0,0,0,.12);
      flex:0 0 auto;
      display:grid;
      place-items:center;
    }
    .kidMini img{ width:100%; height:100%; object-fit:cover; display:block; }
    .kidName{
      font-weight:900;
      font-size:14px;
      opacity:.85;
      max-width:120px;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }
  </style>
</head>
<body>

  <!-- SETUP SCREEN -->
  <div class="screen active" id="setupScreen">
    <div class="setupWrap">
      <div class="setupCard">
        <p class="setupTitle" id="setupTitle">Kid Setup</p>
        <p class="setupNote" id="setupNote">
          Enter the child‚Äôs name and upload a photo. Choose language (RU/EN). Then tap Start.
        </p>

        <div class="setupRow">
          <div class="avatarBox" id="avatarBox">
            <div class="avatarFallback" id="avatarFallback">üëß</div>
            <img id="avatarImg" alt="avatar" style="display:none;" />
          </div>

          <div style="flex:1 1 280px; min-width:240px;">
            <input class="input" id="kidNameInput" placeholder="Name (e.g., Ali)" />
            <div style="height:10px"></div>
            <input class="input" id="photoInput" type="file" accept="image/*" />
          </div>
        </div>

        <div class="setupRow">
          <select class="select" id="langSelect">
            <option value="EN">üá∫üá∏ English</option>
            <option value="RU">üá∑üá∫ –†—É—Å—Å–∫–∏–π</option>
          </select>

          <button class="btn" id="clearBtn">Clear</button>
          <button class="btn primary" id="startBtn">Start</button>
        </div>

        <p class="setupNote" id="ttsNote">
          Tip: On some phones, sound starts after the first tap.
        </p>
      </div>
    </div>
  </div>

  <!-- GAME SCREEN -->
  <div class="screen" id="gameScreen">

    <div class="hud">
      <div class="bubble">
        <div class="flag" id="flagEl">üá∫üá∏</div>
        <div id="taskText" style="font-size:20px;font-weight:900;">Listen üëÇ</div>

        <div class="kidTag" title="Kid">
          <div class="kidMini" id="kidMini">
            <div style="opacity:.55;">üôÇ</div>
          </div>
          <div class="kidName" id="kidNameHud">Ali</div>
        </div>
      </div>

      <div class="score" title="Score">
        <svg class="star" viewBox="0 0 24 24" fill="#ffcc33" xmlns="http://www.w3.org/2000/svg">
          <path d="M12 17.27l-5.18 3.05 1.39-5.9L3 9.24l6.03-.52L12 3l2.97 5.72 6.03.52-5.21 5.18 1.39 5.9z"/>
        </svg>
        <div id="scoreText" style="font-size:22px;">0</div>
      </div>
    </div>

    <div class="game">
      <div class="field">
        <div class="arena" id="arena"></div>
      </div>
    </div>

    <div class="hint">
      <button class="btn" id="newBtn">New</button>
      <button class="btn" id="langBtn">Language: EN</button>
      <button class="btn" id="soundBtn">Beep: On</button>
      <button class="btn" id="voiceBtn">Voice: On</button>
      <button class="btn" id="backBtn">Back</button>
    </div>

    <div class="toast" id="toast">Great!</div>
    <canvas id="fx"></canvas>
  </div>

<script>
(() => {
  const LS_NAME = "kid_name_v1";
  const LS_AVATAR = "kid_avatar_v1";
  const LS_LANG = "kid_lang_v1";

  // ---------------- Beep audio ----------------
  let soundOn = true;
  const AudioCtx = window.AudioContext || window.webkitAudioContext;
  let ctx = null;

  function beep(type="ok"){
    if(!soundOn) return;
    try{
      if(!ctx) ctx = new AudioCtx();
      const t0 = ctx.currentTime;
      const o = ctx.createOscillator();
      const g = ctx.createGain();
      o.connect(g); g.connect(ctx.destination);

      if(type==="ok"){
        o.type="sine";
        o.frequency.setValueAtTime(660, t0);
        o.frequency.exponentialRampToValueAtTime(990, t0 + 0.09);
        g.gain.setValueAtTime(0.001, t0);
        g.gain.exponentialRampToValueAtTime(0.35, t0 + 0.01);
        g.gain.exponentialRampToValueAtTime(0.001, t0 + 0.14);
        o.start(t0); o.stop(t0 + 0.15);
      } else {
        o.type="square";
        o.frequency.setValueAtTime(240, t0);
        g.gain.setValueAtTime(0.001, t0);
        g.gain.exponentialRampToValueAtTime(0.25, t0 + 0.01);
        g.gain.exponentialRampToValueAtTime(0.001, t0 + 0.18);
        o.start(t0); o.stop(t0 + 0.2);
      }
    } catch(e){}
  }

  // ---------------- TTS (SpeechSynthesis) ----------------
  let voiceOn = true;

  function pickVoice(lang){
    const synth = window.speechSynthesis;
    const voices = synth?.getVoices?.() || [];
    const want = (lang === "RU") ? "ru" : "en";
    return voices.find(v => (v.lang || "").toLowerCase().startsWith(want))
        || voices.find(v => (v.lang || "").toLowerCase().includes(want))
        || null;
  }

  function speak(text, lang){
    return new Promise((resolve) => {
      if(!voiceOn) return resolve();
      if(!("speechSynthesis" in window)) return resolve();

      try{
        window.speechSynthesis.cancel();
        const u = new SpeechSynthesisUtterance(text);

        if(lang === "RU"){
          u.lang = "ru-RU";
        } else {
          u.lang = "en-US";
        }

        const v = pickVoice(lang);
        if(v) u.voice = v;

        u.rate = 0.95;
        u.pitch = 1.0;

        u.onend = () => resolve();
        u.onerror = () => resolve();

        window.speechSynthesis.speak(u);

        // fallback
        setTimeout(resolve, 2500);
      }catch(e){
        resolve();
      }
    });
  }

  if("speechSynthesis" in window){
    window.speechSynthesis.onvoiceschanged = () => {};
  }

  // ---------------- Language pack ----------------
  let lang = "EN";
  const LANG = {
    EN: {
      flag:"üá∫üá∏",
      startTitle:"Kid Setup",
      startNote:"Enter the child‚Äôs name and upload a photo. Choose language (RU/EN). Then tap Start.",
      ttsTip:"Tip: On some phones, voice starts after the first tap.",
      btnNew:"New",
      btnBack:"Back",
      btnSoundOn:"Beep: On",
      btnSoundOff:"Beep: Off",
      btnVoiceOn:"Voice: On",
      btnVoiceOff:"Voice: Off",
      langBtn:(l)=>`Language: ${l}`,
      listenHud:"Listen üëÇ",
      task:(name)=>`Find ${name}`,
      correct:(kid)=>`Great job, ${kid}!`,
      wrong:(kid)=>`Wrong, ${kid}. Try again.`,
      toastGreat:"Great!",
      toastTry:"Try again üôÇ"
    },
    RU: {
      flag:"üá∑üá∫",
      startTitle:"–ù–∞—Å—Ç—Ä–æ–π–∫–∞",
      startNote:"–í–≤–µ–¥–∏—Ç–µ –∏–º—è —Ä–µ–±—ë–Ω–∫–∞ –∏ –∑–∞–≥—Ä—É–∑–∏—Ç–µ —Ñ–æ—Ç–æ. –í—ã–±–µ—Ä–∏—Ç–µ —è–∑—ã–∫ (RU/EN). –ó–∞—Ç–µ–º –Ω–∞–∂–º–∏—Ç–µ Start.",
      ttsTip:"–ü–æ–¥—Å–∫–∞–∑–∫–∞: –∏–Ω–æ–≥–¥–∞ –≥–æ–ª–æ—Å –≤–∫–ª—é—á–∞–µ—Ç—Å—è –ø–æ—Å–ª–µ –ø–µ—Ä–≤–æ–≥–æ –Ω–∞–∂–∞—Ç–∏—è.",
      btnNew:"–ù–æ–≤—ã–π",
      btnBack:"–ù–∞–∑–∞–¥",
      btnSoundOn:"–ó–≤—É–∫: –í–∫–ª",
      btnSoundOff:"–ó–≤—É–∫: –í—ã–∫–ª",
      btnVoiceOn:"–ì–æ–ª–æ—Å: –í–∫–ª",
      btnVoiceOff:"–ì–æ–ª–æ—Å: –í—ã–∫–ª",
      langBtn:(l)=>`–Ø–∑—ã–∫: ${l}`,
      listenHud:"–°–ª—É—à–∞–π üëÇ",
      task:(name)=>`–ù–∞–π–¥–∏ ${name}`,
      correct:(kid)=>`–ü—Ä–∞–≤–∏–ª—å–Ω–æ, ${kid}!`,
      wrong:(kid)=>`–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ, ${kid}. –ü–æ–ø—Ä–æ–±—É–π –µ—â—ë.`,
      toastGreat:"–û—Ç–ª–∏—á–Ω–æ!",
      toastTry:"–ü–æ–ø—Ä–æ–±—É–π –µ—â—ë üôÇ"
    }
  };

  // ---------------- Items ----------------
  const NUMBERS = Array.from({length:20}, (_,i)=>{
    const n = i+1;
    return { icon:String(n), en:`number ${n}`, ru:`—á–∏—Å–ª–æ ${n}` };
  });

  const FRUITS = [
    {icon:"üçé", en:"apple", ru:"—è–±–ª–æ–∫–æ"},
    {icon:"üçè", en:"green apple", ru:"–∑–µ–ª—ë–Ω–æ–µ —è–±–ª–æ–∫–æ"},
    {icon:"üçê", en:"pear", ru:"–≥—Ä—É—à—É"},
    {icon:"üçä", en:"orange", ru:"–∞–ø–µ–ª—å—Å–∏–Ω"},
    {icon:"üçã", en:"lemon", ru:"–ª–∏–º–æ–Ω"},
    {icon:"üçå", en:"banana", ru:"–±–∞–Ω–∞–Ω"},
    {icon:"üçâ", en:"watermelon", ru:"–∞—Ä–±—É–∑"},
    {icon:"üçá", en:"grapes", ru:"–≤–∏–Ω–æ–≥—Ä–∞–¥"},
    {icon:"üçì", en:"strawberry", ru:"–∫–ª—É–±–Ω–∏–∫—É"},
    {icon:"ü´ê", en:"blueberries", ru:"–≥–æ–ª—É–±–∏–∫—É"},
    {icon:"üçí", en:"cherries", ru:"–≤–∏—à–Ω—é"},
    {icon:"üçë", en:"peach", ru:"–ø–µ—Ä—Å–∏–∫"},
    {icon:"ü•≠", en:"mango", ru:"–º–∞–Ω–≥–æ"},
    {icon:"üçç", en:"pineapple", ru:"–∞–Ω–∞–Ω–∞—Å"},
    {icon:"ü••", en:"coconut", ru:"–∫–æ–∫–æ—Å"},
    {icon:"ü•ù", en:"kiwi", ru:"–∫–∏–≤–∏"},
    {icon:"üçÖ", en:"tomato", ru:"–ø–æ–º–∏–¥–æ—Ä"},
    {icon:"ü•ë", en:"avocado", ru:"–∞–≤–æ–∫–∞–¥–æ"},
    {icon:"üçà", en:"melon", ru:"–¥—ã–Ω—é"},
    {icon:"üçê", en:"juicy pear", ru:"—Å–æ—á–Ω—É—é –≥—Ä—É—à—É"},
    {icon:"üçé", en:"red apple", ru:"–∫—Ä–∞—Å–Ω–æ–µ —è–±–ª–æ–∫–æ"},
    {icon:"üçì", en:"sweet strawberry", ru:"—Å–ª–∞–¥–∫—É—é –∫–ª—É–±–Ω–∏–∫—É"},
    {icon:"üçá", en:"purple grapes", ru:"—Ñ–∏–æ–ª–µ—Ç–æ–≤—ã–π –≤–∏–Ω–æ–≥—Ä–∞–¥"},
    {icon:"üçä", en:"tangerine", ru:"–º–∞–Ω–¥–∞—Ä–∏–Ω"},
    {icon:"üçã", en:"sour lemon", ru:"–∫–∏—Å–ª—ã–π –ª–∏–º–æ–Ω"},
    {icon:"üçå", en:"ripe banana", ru:"—Å–ø–µ–ª—ã–π –±–∞–Ω–∞–Ω"},
    {icon:"üçâ", en:"big watermelon", ru:"–±–æ–ª—å—à–æ–π –∞—Ä–±—É–∑"},
    {icon:"üçë", en:"pink peach", ru:"—Ä–æ–∑–æ–≤—ã–π –ø–µ—Ä—Å–∏–∫"},
    {icon:"ü•≠", en:"sweet mango", ru:"—Å–ª–∞–¥–∫–æ–µ –º–∞–Ω–≥–æ"},
    {icon:"üçç", en:"fresh pineapple", ru:"—Å–≤–µ–∂–∏–π –∞–Ω–∞–Ω–∞—Å"},
    {icon:"ü•ù", en:"green kiwi", ru:"–∑–µ–ª—ë–Ω—ã–π –∫–∏–≤–∏"},
    {icon:"ü••", en:"coconut", ru:"–∫–æ–∫–æ—Å"},
    {icon:"üçí", en:"two cherries", ru:"–¥–≤–µ –≤–∏—à–Ω–∏"},
    {icon:"ü´ê", en:"blueberries", ru:"–≥–æ–ª—É–±–∏–∫—É"},
    {icon:"üçà", en:"melon", ru:"–¥—ã–Ω—é"},
    {icon:"ü•ë", en:"avocado", ru:"–∞–≤–æ–∫–∞–¥–æ"},
    {icon:"üçÖ", en:"tomato", ru:"–ø–æ–º–∏–¥–æ—Ä"},
    {icon:"üçé", en:"apple", ru:"—è–±–ª–æ–∫–æ"},
    {icon:"üçè", en:"green apple", ru:"–∑–µ–ª—ë–Ω–æ–µ —è–±–ª–æ–∫–æ"},
    {icon:"üçä", en:"orange", ru:"–∞–ø–µ–ª—å—Å–∏–Ω"},
    {icon:"üçá", en:"grapes", ru:"–≤–∏–Ω–æ–≥—Ä–∞–¥"},
    {icon:"üçì", en:"strawberry", ru:"–∫–ª—É–±–Ω–∏–∫—É"},
    {icon:"ü•ù", en:"kiwi", ru:"–∫–∏–≤–∏"},
    {icon:"ü•≠", en:"mango", ru:"–º–∞–Ω–≥–æ"},
    {icon:"üçç", en:"pineapple", ru:"–∞–Ω–∞–Ω–∞—Å"},
    {icon:"üçã", en:"lemon", ru:"–ª–∏–º–æ–Ω"},
    {icon:"üçå", en:"banana", ru:"–±–∞–Ω–∞–Ω"},
    {icon:"üçâ", en:"watermelon", ru:"–∞—Ä–±—É–∑"},
    {icon:"üçí", en:"cherries", ru:"–≤–∏—à–Ω—é"}
  ];

  const OBJECTS = [
    {icon:"‚öΩ", en:"ball", ru:"–º—è—á"},
    {icon:"üèÄ", en:"basketball", ru:"–±–∞—Å–∫–µ—Ç–±–æ–ª—å–Ω—ã–π –º—è—á"},
    {icon:"üèà", en:"football", ru:"–º—è—á –¥–ª—è —Ñ—É—Ç–±–æ–ª–∞"},
    {icon:"üéæ", en:"tennis ball", ru:"—Ç–µ–Ω–Ω–∏—Å–Ω—ã–π –º—è—á"},
    {icon:"üèê", en:"volleyball", ru:"–≤–æ–ª–µ–π–±–æ–ª—å–Ω—ã–π –º—è—á"},
    {icon:"üß∏", en:"teddy bear", ru:"–ø–ª—é—à–µ–≤–æ–≥–æ –º–∏—à–∫—É"},
    {icon:"üöó", en:"car", ru:"–º–∞—à–∏–Ω—É"},
    {icon:"üöï", en:"taxi", ru:"—Ç–∞–∫—Å–∏"},
    {icon:"üöô", en:"SUV", ru:"–≤–Ω–µ–¥–æ—Ä–æ–∂–Ω–∏–∫"},
    {icon:"üöå", en:"bus", ru:"–∞–≤—Ç–æ–±—É—Å"},
    {icon:"üö≤", en:"bicycle", ru:"–≤–µ–ª–æ—Å–∏–ø–µ–¥"},
    {icon:"üõ¥", en:"scooter", ru:"—Å–∞–º–æ–∫–∞—Ç"},
    {icon:"‚úàÔ∏è", en:"airplane", ru:"—Å–∞–º–æ–ª—ë—Ç"},
    {icon:"üöÄ", en:"rocket", ru:"—Ä–∞–∫–µ—Ç—É"},
    {icon:"‚åö", en:"watch", ru:"—á–∞—Å—ã"},
    {icon:"üì±", en:"phone", ru:"—Ç–µ–ª–µ—Ñ–æ–Ω"},
    {icon:"üí°", en:"light bulb", ru:"–ª–∞–º–ø–æ—á–∫—É"},
    {icon:"üîë", en:"key", ru:"–∫–ª—é—á"},
    {icon:"üéà", en:"balloon", ru:"—à–∞—Ä–∏–∫"},
    {icon:"üéÅ", en:"gift", ru:"–ø–æ–¥–∞—Ä–æ–∫"},
    {icon:"üßÉ", en:"juice box", ru:"—Å–æ–∫"},
    {icon:"üçØ", en:"honey jar", ru:"–º—ë–¥"},
    {icon:"ü•õ", en:"milk", ru:"–º–æ–ª–æ–∫–æ"},
    {icon:"üçº", en:"baby bottle", ru:"–±—É—Ç—ã–ª–æ—á–∫—É"},
    {icon:"üß©", en:"puzzle", ru:"–ø–∞–∑–ª"},
    {icon:"üìö", en:"books", ru:"–∫–Ω–∏–≥–∏"},
    {icon:"‚úèÔ∏è", en:"pencil", ru:"–∫–∞—Ä–∞–Ω–¥–∞—à"},
    {icon:"üñçÔ∏è", en:"crayon", ru:"–º–µ–ª–æ–∫"},
    {icon:"üßÅ", en:"cupcake", ru:"–∫–µ–∫—Å"},
    {icon:"üç™", en:"cookie", ru:"–ø–µ—á–µ–Ω—å–µ"},
    {icon:"üç¨", en:"candy", ru:"–∫–æ–Ω—Ñ–µ—Ç—É"},
    {icon:"üéµ", en:"music note", ru:"–Ω–æ—Ç—É"},
    {icon:"üéß", en:"headphones", ru:"–Ω–∞—É—à–Ω–∏–∫–∏"},
    {icon:"üì∑", en:"camera", ru:"–∫–∞–º–µ—Ä—É"},
    {icon:"üß¢", en:"cap", ru:"–∫–µ–ø–∫—É"},
    {icon:"üëü", en:"shoe", ru:"–∫—Ä–æ—Å—Å–æ–≤–æ–∫"},
    {icon:"üß§", en:"glove", ru:"–ø–µ—Ä—á–∞—Ç–∫—É"},
    {icon:"üß£", en:"scarf", ru:"—à–∞—Ä—Ñ"},
    {icon:"üï∂Ô∏è", en:"sunglasses", ru:"–æ—á–∫–∏"},
    {icon:"‚òÇÔ∏è", en:"umbrella", ru:"–∑–æ–Ω—Ç"},
    {icon:"ü™Å", en:"kite", ru:"–≤–æ–∑–¥—É—à–Ω–æ–≥–æ –∑–º–µ—è"},
    {icon:"üßπ", en:"broom", ru:"–º–µ—Ç–ª—É"},
    {icon:"üß∫", en:"basket", ru:"–∫–æ—Ä–∑–∏–Ω—É"},
    {icon:"ü™£", en:"bucket", ru:"–≤–µ–¥—Ä–æ"},
    {icon:"ü™•", en:"toothbrush", ru:"–∑—É–±–Ω—É—é —â—ë—Ç–∫—É"},
    {icon:"üßº", en:"soap", ru:"–º—ã–ª–æ"},
    {icon:"üßΩ", en:"sponge", ru:"–≥—É–±–∫—É"},
    {icon:"üîî", en:"bell", ru:"–∫–æ–ª–æ–∫–æ–ª—å—á–∏–∫"},
    {icon:"ü™Ä", en:"yo-yo", ru:"–π–æ-–π–æ"},
    {icon:"üé≤", en:"dice", ru:"–∫—É–±–∏–∫"}
  ];

  const ANIMALS = [
    {icon:"üê∂", en:"dog", ru:"—Å–æ–±–∞–∫—É"},
    {icon:"üê±", en:"cat", ru:"–∫–æ—à–∫—É"},
    {icon:"üê≠", en:"mouse", ru:"–º—ã—à—å"},
    {icon:"üêπ", en:"hamster", ru:"—Ö–æ–º—è–∫–∞"},
    {icon:"üê∞", en:"rabbit", ru:"–∫—Ä–æ–ª–∏–∫–∞"},
    {icon:"ü¶ä", en:"fox", ru:"–ª–∏—Å—É"},
    {icon:"üêª", en:"bear", ru:"–º–µ–¥–≤–µ–¥—è"},
    {icon:"üêº", en:"panda", ru:"–ø–∞–Ω–¥—É"},
    {icon:"üê®", en:"koala", ru:"–∫–æ–∞–ª—É"},
    {icon:"üêØ", en:"tiger", ru:"—Ç–∏–≥—Ä–∞"},
    {icon:"ü¶Å", en:"lion", ru:"–ª—å–≤–∞"},
    {icon:"üêÆ", en:"cow", ru:"–∫–æ—Ä–æ–≤—É"},
    {icon:"üê∑", en:"pig", ru:"—Å–≤–∏–Ω—å—é"},
    {icon:"üê∏", en:"frog", ru:"–ª—è–≥—É—à–∫—É"},
    {icon:"üêµ", en:"monkey", ru:"–æ–±–µ–∑—å—è–Ω—É"},
    {icon:"üêî", en:"chicken", ru:"–∫—É—Ä–∏—Ü—É"},
    {icon:"üêß", en:"penguin", ru:"–ø–∏–Ω–≥–≤–∏–Ω–∞"},
    {icon:"ü¶Ü", en:"duck", ru:"—É—Ç–∫—É"},
    {icon:"ü¶â", en:"owl", ru:"—Å–æ–≤—É"},
    {icon:"ü¶Ñ", en:"unicorn", ru:"–µ–¥–∏–Ω–æ—Ä–æ–≥–∞"},
    {icon:"üê¥", en:"horse", ru:"–ª–æ—à–∞–¥—å"},
    {icon:"üê∫", en:"wolf", ru:"–≤–æ–ª–∫–∞"},
    {icon:"üêó", en:"boar", ru:"–∫–∞–±–∞–Ω–∞"},
    {icon:"üêç", en:"snake", ru:"–∑–º–µ—é"},
    {icon:"ü¶ñ", en:"dinosaur", ru:"–¥–∏–Ω–æ–∑–∞–≤—Ä–∞"},
    {icon:"ü¶ï", en:"dino", ru:"–¥–∏–Ω–æ–∑–∞–≤—Ä–∞"},
    {icon:"üê¢", en:"turtle", ru:"—á–µ—Ä–µ–ø–∞—Ö—É"},
    {icon:"üê†", en:"fish", ru:"—Ä—ã–±—É"},
    {icon:"üê¨", en:"dolphin", ru:"–¥–µ–ª—å—Ñ–∏–Ω–∞"},
    {icon:"ü¶à", en:"shark", ru:"–∞–∫—É–ª—É"},
    {icon:"üêô", en:"octopus", ru:"–æ—Å—å–º–∏–Ω–æ–≥–∞"},
    {icon:"ü¶Ä", en:"crab", ru:"–∫—Ä–∞–±–∞"},
    {icon:"ü¶ã", en:"butterfly", ru:"–±–∞–±–æ—á–∫—É"},
    {icon:"üêû", en:"ladybug", ru:"–±–æ–∂—å—é –∫–æ—Ä–æ–≤–∫—É"},
    {icon:"üêù", en:"bee", ru:"–ø—á–µ–ª—É"},
    {icon:"ü™≤", en:"beetle", ru:"–∂—É–∫–∞"},
    {icon:"ü¶ó", en:"cricket", ru:"—Å–≤–µ—Ä—á–∫–∞"},
    {icon:"ü¶Ç", en:"scorpion", ru:"—Å–∫–æ—Ä–ø–∏–æ–Ω–∞"},
    {icon:"üï∑Ô∏è", en:"spider", ru:"–ø–∞—É–∫–∞"},
    {icon:"üêå", en:"snail", ru:"—É–ª–∏—Ç–∫—É"},
    {icon:"ü¶î", en:"hedgehog", ru:"—ë–∂–∏–∫–∞"},
    {icon:"ü¶á", en:"bat", ru:"–ª–µ—Ç—É—á—É—é –º—ã—à—å"},
    {icon:"ü¶¢", en:"swan", ru:"–ª–µ–±–µ–¥—è"},
    {icon:"ü¶ö", en:"peacock", ru:"–ø–∞–≤–ª–∏–Ω–∞"},
    {icon:"ü¶ú", en:"parrot", ru:"–ø–æ–ø—É–≥–∞—è"},
    {icon:"üêò", en:"elephant", ru:"—Å–ª–æ–Ω–∞"},
    {icon:"ü¶í", en:"giraffe", ru:"–∂–∏—Ä–∞—Ñ–∞"},
    {icon:"ü¶ì", en:"zebra", ru:"–∑–µ–±—Ä—É"},
    {icon:"ü¶ò", en:"kangaroo", ru:"–∫–µ–Ω–≥—É—Ä—É"},
    {icon:"ü¶•", en:"sloth", ru:"–ª–µ–Ω–∏–≤—Ü–∞"}
  ];

  function allItems(){
    return [...NUMBERS, ...FRUITS, ...OBJECTS, ...ANIMALS];
  }

  function randInt(a,b){ return Math.floor(Math.random()*(b-a+1))+a; }
  function pick(arr){ return arr[Math.floor(Math.random()*arr.length)]; }
  function showToast(el, text){
    el.textContent = text;
    el.classList.add("show");
    setTimeout(()=>el.classList.remove("show"), 650);
  }
  function vibrate(ms=60){
    if(navigator.vibrate) navigator.vibrate(ms);
  }

  // ---------------- Confetti ----------------
  const canvas = document.getElementById("fx");
  const c = canvas.getContext("2d");
  let W=0,H=0, confetti=[];
  const colors = ["#ffb703","#fb8500","#ff006e","#8338ec","#3a86ff","#06d6a0","#8ac926","#ff595e"];
  function resize(){
    W = canvas.width = window.innerWidth * devicePixelRatio;
    H = canvas.height = window.innerHeight * devicePixelRatio;
  }
  window.addEventListener("resize", resize);
  resize();

  function popConfetti(){
    const n = 80;
    for(let i=0;i<n;i++){
      confetti.push({
        x: (window.innerWidth/2) * devicePixelRatio,
        y: (window.innerHeight/2) * devicePixelRatio,
        vx: (Math.random()*2-1) * 14,
        vy: (Math.random()*2-1) * 14 - 8,
        g: 0.6 + Math.random()*0.4,
        s: 6 + Math.random()*10,
        r: Math.random()*Math.PI,
        vr:(Math.random()*2-1)*0.2,
        col: pick(colors)
      });
    }
  }

  function tick(){
    c.clearRect(0,0,W,H);
    confetti = confetti.filter(p => p.y < H+80 && p.s>0.5);
    for(const p of confetti){
      p.vy += p.g;
      p.x += p.vx;
      p.y += p.vy;
      p.r += p.vr;
      p.s *= 0.995;

      c.save();
      c.translate(p.x,p.y);
      c.rotate(p.r);
      c.fillStyle = p.col;
      c.fillRect(-p.s/2, -p.s/2, p.s, p.s);
      c.restore();
    }
    requestAnimationFrame(tick);
  }
  tick();

  // ---------------- Screens / UI elements ----------------
  const setupScreen = document.getElementById("setupScreen");
  const gameScreen = document.getElementById("gameScreen");

  const setupTitle = document.getElementById("setupTitle");
  const setupNote = document.getElementById("setupNote");
  const ttsNote = document.getElementById("ttsNote");

  const kidNameInput = document.getElementById("kidNameInput");
  const photoInput = document.getElementById("photoInput");
  const avatarImg = document.getElementById("avatarImg");
  const avatarFallback = document.getElementById("avatarFallback");

  const langSelect = document.getElementById("langSelect");
  const clearBtn = document.getElementById("clearBtn");
  const startBtn = document.getElementById("startBtn");

  const flagEl = document.getElementById("flagEl");
  const taskText = document.getElementById("taskText");
  const scoreText = document.getElementById("scoreText");
  const toast = document.getElementById("toast");

  const kidMini = document.getElementById("kidMini");
  const kidNameHud = document.getElementById("kidNameHud");

  const arena = document.getElementById("arena");

  const newBtn = document.getElementById("newBtn");
  const langBtn = document.getElementById("langBtn");
  const soundBtn = document.getElementById("soundBtn");
  const voiceBtn = document.getElementById("voiceBtn");
  const backBtn = document.getElementById("backBtn");

  // ---------------- Game state ----------------
  let score = 0;
  let count = 3;
  let targetItem = null;
  let kidName = "Ali";
  let kidAvatar = null;

  function applyLanguageUI(){
    document.documentElement.lang = (lang==="RU") ? "ru" : "en";
    flagEl.textContent = LANG[lang].flag;

    setupTitle.textContent = LANG[lang].startTitle;
    setupNote.textContent = LANG[lang].startNote;
    ttsNote.textContent = LANG[lang].ttsTip;

    newBtn.textContent = LANG[lang].btnNew;
    backBtn.textContent = LANG[lang].btnBack;
    langBtn.textContent = LANG[lang].langBtn(lang);
    soundBtn.textContent = soundOn ? LANG[lang].btnSoundOn : LANG[lang].btnSoundOff;
    voiceBtn.textContent = voiceOn ? LANG[lang].btnVoiceOn : LANG[lang].btnVoiceOff;

    taskText.textContent = LANG[lang].listenHud;
  }

  function switchToSetup(){
    setupScreen.classList.add("active");
    gameScreen.classList.remove("active");
    if("speechSynthesis" in window) window.speechSynthesis.cancel();
  }

  function switchToGame(){
    setupScreen.classList.remove("active");
    gameScreen.classList.add("active");
    applyKidHud();
    applyLanguageUI();
    newLevel();
  }

  function applyKidHud(){
    kidNameHud.textContent = kidName || "Kid";
    kidMini.innerHTML = "";
    if(kidAvatar){
      const im = document.createElement("img");
      im.src = kidAvatar;
      im.alt = "kid";
      kidMini.appendChild(im);
    } else {
      const d = document.createElement("div");
      d.style.opacity = ".55";
      d.textContent = "üôÇ";
      kidMini.appendChild(d);
    }
  }

  function setSetupAvatar(dataUrl){
    kidAvatar = dataUrl || null;
    if(kidAvatar){
      avatarImg.src = kidAvatar;
      avatarImg.style.display = "block";
      avatarFallback.style.display = "none";
    } else {
      avatarImg.style.display = "none";
      avatarFallback.style.display = "block";
    }
  }

  function loadSaved(){
    const savedName = localStorage.getItem(LS_NAME);
    const savedAvatar = localStorage.getItem(LS_AVATAR);
    const savedLang = localStorage.getItem(LS_LANG);

    if(savedName) kidNameInput.value = savedName;
    if(savedAvatar) setSetupAvatar(savedAvatar);

    if(savedLang === "RU" || savedLang === "EN"){
      lang = savedLang;
      langSelect.value = savedLang;
    } else {
      lang = "EN";
      langSelect.value = "EN";
    }
    applyLanguageUI();
  }

  function saveAll(){
    localStorage.setItem(LS_NAME, kidName || "");
    if(kidAvatar) localStorage.setItem(LS_AVATAR, kidAvatar);
    else localStorage.removeItem(LS_AVATAR);
    localStorage.setItem(LS_LANG, lang);
  }

  // ---------------- Placement collision ----------------
  function intersects(a, b){
    return !(a.x + a.w < b.x || b.x + b.w < a.x || a.y + a.h < b.y || b.y + b.h < a.y);
  }

  async function newLevel(){
    arena.innerHTML = "";

    if(score < 5) count = 3;
    else if(score < 12) count = 4;
    else if(score < 22) count = 5;
    else count = 6;

    const pool = allItems();
    targetItem = pick(pool);

    const chosen = [targetItem];
    while(chosen.length < count){
      const it = pick(pool);
      if(!chosen.includes(it)) chosen.push(it);
    }
    for(let i=chosen.length-1;i>0;i--){
      const j = Math.floor(Math.random()*(i+1));
      [chosen[i], chosen[j]] = [chosen[j], chosen[i]];
    }

    // DO NOT show target in HUD. Only "Listen"
    taskText.textContent = LANG[lang].listenHud;

    // Speak task
    const targetName = (lang === "RU") ? targetItem.ru : targetItem.en;
    speak(LANG[lang].task(targetName), lang);

    const box = arena.getBoundingClientRect();
    const pad = 12;
    const placed = [];

    chosen.forEach((it) => {
      const tile = document.createElement("div");
      tile.className = "tile";

      const big = document.createElement("div");
      big.className = "big";
      big.textContent = it.icon;

      // no label under cards
      tile.appendChild(big);
      arena.appendChild(tile);

      const r = tile.getBoundingClientRect();
      const w = r.width;
      const h = r.height;

      const minX = pad;
      const minY = pad;
      const maxX = box.width - pad;
      const maxY = box.height - pad;

      let tries = 0;
      let rect;
      do{
        tries++;
        const x = randInt(minX, Math.max(minX, maxX - w));
        const y = randInt(minY, Math.max(minY, maxY - h));
        rect = { x, y, w, h };
      } while(placed.some(p => intersects(rect, p)) && tries < 500);

      placed.push(rect);
      tile.style.left = rect.x + "px";
      tile.style.top  = rect.y + "px";

      tile.addEventListener("pointerdown", async () => {
        if(soundOn && ctx && ctx.state === "suspended"){
          ctx.resume().catch(()=>{});
        }

        if(it === targetItem){
          score++;
          scoreText.textContent = score;

          beep("ok");
          showToast(toast, LANG[lang].toastGreat);
          popConfetti();

          // wait for voice to finish, then pause, then next level
          await speak(LANG[lang].correct(kidName || "Kid"), lang);
          await new Promise(r => setTimeout(r, 500));
          newLevel();
        } else {
          beep("no");
          vibrate(60);
          showToast(toast, LANG[lang].toastTry);

          await speak(LANG[lang].wrong(kidName || "Kid"), lang);
        }
      });
    });
  }

  // ---------------- Buttons ----------------
  newBtn.addEventListener("click", newLevel);

  langBtn.addEventListener("click", () => {
    lang = (lang === "EN") ? "RU" : "EN";
    langSelect.value = lang;
    saveAll();
    applyLanguageUI();
    newLevel();
  });

  soundBtn.addEventListener("click", () => {
    soundOn = !soundOn;
    soundBtn.textContent = soundOn ? LANG[lang].btnSoundOn : LANG[lang].btnSoundOff;
    if(soundOn && !ctx){
      try{ ctx = new AudioCtx(); }catch(e){}
    }
  });

  voiceBtn.addEventListener("click", () => {
    voiceOn = !voiceOn;
    voiceBtn.textContent = voiceOn ? LANG[lang].btnVoiceOn : LANG[lang].btnVoiceOff;
    if(!voiceOn && "speechSynthesis" in window) window.speechSynthesis.cancel();
  });

  backBtn.addEventListener("click", () => {
    saveAll();
    switchToSetup();
  });

  // ---------------- Setup events ----------------
  langSelect.addEventListener("change", () => {
    const v = langSelect.value;
    lang = (v === "RU") ? "RU" : "EN";
    saveAll();
    applyLanguageUI();
  });

  photoInput.addEventListener("change", () => {
    const f = photoInput.files && photoInput.files[0];
    if(!f) return;
    const reader = new FileReader();
    reader.onload = () => {
      const dataUrl = String(reader.result || "");
      setSetupAvatar(dataUrl);
      saveAll();
    };
    reader.readAsDataURL(f);
  });

  clearBtn.addEventListener("click", () => {
    kidNameInput.value = "";
    photoInput.value = "";
    setSetupAvatar(null);
    localStorage.removeItem(LS_NAME);
    localStorage.removeItem(LS_AVATAR);
  });

  startBtn.addEventListener("click", () => {
    kidName = (kidNameInput.value || "").trim() || "Ali";
    kidAvatar = avatarImg.style.display === "block" ? avatarImg.src : null;
    saveAll();
    switchToGame();
  });

  // first tap wake-up for audio + voice
  window.addEventListener("pointerdown", async () => {
    try{
      if(soundOn){
        if(!ctx) ctx = new AudioCtx();
        if(ctx.state === "suspended") await ctx.resume();
      }
      if(voiceOn){
        await speak(lang === "RU" ? "–ù–∞—á–Ω—ë–º!" : "Let‚Äôs start!", lang);
      }
    }catch(e){}
  }, { once:true });

  // ---------------- Init ----------------
  loadSaved();
})();
</script>
</body>
</html>
