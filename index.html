<!DOCTYPE html>
<html lang="az">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Tap Oyunu</title>

  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#4FD1C5">

  <style>
    :root{
      --bg1:#b9f6ca;
      --bg2:#81e6d9;
      --card:#ffffff;
      --text:#1a202c;
      --muted:#718096;
      --btn:#2d3748;
      --btn2:#edf2f7;
      --shadow:0 12px 30px rgba(0,0,0,.14);
      --radius:22px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,sans-serif;
      min-height:100vh;
      background:linear-gradient(180deg,var(--bg1),var(--bg2));
      display:flex;
      align-items:center;
      justify-content:center;
      padding:18px;
      color:var(--text);
    }
    .wrap{
      width:100%;
      max-width:460px;
    }
    .panel{
      background:var(--card);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:18px 18px 14px;
    }
    .title{
      font-size:32px;
      font-weight:800;
      margin:6px 0 10px;
      letter-spacing:.2px;
    }
    .sub{
      margin:0 0 14px;
      color:var(--muted);
      font-size:13px;
      line-height:1.35;
    }

    .row{
      display:flex;
      gap:12px;
      align-items:center;
    }
    .avatar{
      width:76px;
      height:76px;
      border-radius:50%;
      background:#e2e8f0;
      overflow:hidden;
      flex:0 0 auto;
      display:flex;
      align-items:center;
      justify-content:center;
      box-shadow:0 6px 14px rgba(0,0,0,.12);
    }
    .avatar img{
      width:100%;
      height:100%;
      object-fit:cover;
      display:none;
    }
    .avatar .ph{
      font-size:30px;
      opacity:.65;
    }

    .field{
      width:100%;
      margin:10px 0;
    }
    input[type="text"], select{
      width:100%;
      padding:13px 14px;
      border-radius:16px;
      border:1px solid #e2e8f0;
      font-size:16px;
      outline:none;
      background:#fff;
    }
    input[type="text"]::placeholder{color:#a0aec0}
    .file{
      width:100%;
      padding:12px 14px;
      border-radius:16px;
      border:1px dashed #cbd5e0;
      background:#f7fafc;
      font-size:15px;
    }

    .btnRow{
      display:flex;
      gap:10px;
      margin-top:12px;
    }
    button{
      width:100%;
      padding:13px 14px;
      border-radius:16px;
      border:0;
      font-size:16px;
      font-weight:700;
      cursor:pointer;
    }
    .btnPrimary{
      background:var(--btn);
      color:#fff;
    }
    .btnGhost{
      background:var(--btn2);
      color:var(--text);
    }

    /* GAME */
    .topBar{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      margin-bottom:14px;
    }
    .pill{
      display:flex;
      align-items:center;
      gap:10px;
      background:#ffffffcc;
      border:1px solid #e2e8f0;
      padding:10px 12px;
      border-radius:18px;
      box-shadow:0 8px 18px rgba(0,0,0,.08);
      backdrop-filter: blur(6px);
    }
    .pill b{font-size:16px}
    .score{
      min-width:88px;
      justify-content:center;
    }
    .grid{
      display:grid;
      grid-template-columns:repeat(2, 1fr);
      gap:14px;
      margin-top:10px;
    }
    .cardItem{
      background:#ffffffcc;
      border:1px solid #e2e8f0;
      border-radius:22px;
      height:120px;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:54px;
      user-select:none;
      cursor:pointer;
      box-shadow:0 10px 22px rgba(0,0,0,.08);
      transition:transform .08s ease;
    }
    .cardItem:active{transform:scale(.98)}
    .gameBtns{
      display:flex;
      gap:10px;
      margin-top:14px;
    }
    .tiny{
      margin-top:10px;
      color:var(--muted);
      font-size:12px;
      text-align:center;
    }

    .hidden{display:none}
  </style>
</head>

<body>
  <div class="wrap">

    <!-- SETTINGS -->
    <div id="settings" class="panel">
      <div class="title" id="t_settings">Ayarlar</div>
      <p class="sub" id="t_hint">
        U≈üaƒüƒ±n adƒ±nƒ± yazƒ±n v…ô ≈ü…ôkil y√ºkl…ôyin. Dili se√ßin (AZ/RU/EN). Sonra Start basƒ±n.
      </p>

      <div class="row">
        <div class="avatar" id="avatarBox">
          <span class="ph">üëß</span>
          <img id="avatarImg" alt="avatar"/>
        </div>

        <div style="flex:1">
          <div class="field">
            <input id="childName" type="text" placeholder="U≈üaƒüƒ±n adƒ±" />
          </div>
          <div class="field">
            <input id="photoInput" class="file" type="file" accept="image/*" />
          </div>
        </div>
      </div>

      <div class="field">
        <select id="langSelect">
          <option value="az">üá¶üáø Az…ôrbaycan</option>
          <option value="ru">üá∑üá∫ –†—É—Å—Å–∫–∏–π</option>
          <option value="en">üá¨üáß English</option>
        </select>
      </div>

      <div class="btnRow">
        <button class="btnGhost" id="btnClear" type="button">Clear</button>
        <button class="btnPrimary" id="btnStart" type="button">Start</button>
      </div>

      <div class="tiny" id="t_tip">
        ƒ∞pucu: B…ôz…ôn s…ôs ilk toxunu≈üdan sonra aktiv olur.
      </div>
    </div>

    <!-- GAME -->
    <div id="game" class="hidden">
      <div class="topBar">
        <div class="pill">
          <span id="flag">üá¶üáø</span>
          <b id="t_taskLabel">Tap</b>
          <span id="childChip" style="color:#4a5568"></span>
        </div>

        <div class="pill score">
          ‚≠ê <b id="score">0</b>
        </div>
      </div>

      <!-- Tap≈üƒ±rƒ±q ekranda yazƒ±lmayacaq: yalnƒ±z s…ôs -->
      <div class="panel">
        <div class="grid" id="grid"></div>

        <div class="gameBtns">
          <button class="btnGhost" id="btnNew" type="button">Yeni</button>
          <button class="btnGhost" id="btnBack" type="button">Geri</button>
        </div>

        <div class="tiny" id="t_gameTip">
          Tap≈üƒ±rƒ±q yalnƒ±z s…ôs il…ô deyilir.
        </div>
      </div>
    </div>

  </div>

<script>
/* ===================== I18N ===================== */
const I18N = {
  az: {
    settings: "Ayarlar",
    hint: "U≈üaƒüƒ±n adƒ±nƒ± yazƒ±n v…ô ≈ü…ôkil y√ºkl…ôyin. Dili se√ßin (AZ/RU/EN). Sonra Start basƒ±n.",
    tip: "ƒ∞pucu: B…ôz…ôn s…ôs ilk toxunu≈üdan sonra aktiv olur.",
    clear: "Clear",
    start: "Start",
    new: "Yeni",
    back: "Geri",
    taskLabel: "Tap",
    gameTip: "Tap≈üƒ±rƒ±q yalnƒ±z s…ôs il…ô deyilir.",
    sayFind: (x) => `${x}-i tap`,
    bravo: (name)=> `Aferin, ${name}!`,
    wrong: (name)=> `Yalnƒ±≈üdƒ±r, ${name}. T…ôkrar c…ôhd et.`
  },
  ru: {
    settings: "–ù–∞—Å—Ç—Ä–æ–π–∫–∞",
    hint: "–í–≤–µ–¥–∏—Ç–µ –∏–º—è —Ä–µ–±—ë–Ω–∫–∞ –∏ –∑–∞–≥—Ä—É–∑–∏—Ç–µ —Ñ–æ—Ç–æ. –í—ã–±–µ—Ä–∏—Ç–µ —è–∑—ã–∫ (RU/EN/AZ). –ó–∞—Ç–µ–º –Ω–∞–∂–º–∏—Ç–µ Start.",
    tip: "–ü–æ–¥—Å–∫–∞–∑–∫–∞: –∏–Ω–æ–≥–¥–∞ –≥–æ–ª–æ—Å –≤–∫–ª—é—á–∞–µ—Ç—Å—è –ø–æ—Å–ª–µ –ø–µ—Ä–≤–æ–≥–æ –Ω–∞–∂–∞—Ç–∏—è.",
    clear: "Clear",
    start: "Start",
    new: "–ù–æ–≤—ã–π",
    back: "–ù–∞–∑–∞–¥",
    taskLabel: "–ù–∞–π–¥–∏",
    gameTip: "–ó–∞–¥–∞–Ω–∏–µ –∑–≤—É—á–∏—Ç —Ç–æ–ª—å–∫–æ –≥–æ–ª–æ—Å–æ–º.",
    sayFind: (x) => `–ù–∞–π–¥–∏ ${x}`,
    bravo: (name)=> `–ü—Ä–∞–≤–∏–ª—å–Ω–æ, ${name}!`,
    wrong: (name)=> `–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ, ${name}. –ü–æ–ø—Ä–æ–±—É–π –µ—â—ë —Ä–∞–∑.`
  },
  en: {
    settings: "Settings",
    hint: "Enter the child's name and upload a photo. Choose language (EN/RU/AZ). Then press Start.",
    tip: "Tip: sometimes voice works after the first tap.",
    clear: "Clear",
    start: "Start",
    new: "New",
    back: "Back",
    taskLabel: "Find",
    gameTip: "The task is spoken only.",
    sayFind: (x) => `Find ${x}`,
    bravo: (name)=> `Great job, ${name}!`,
    wrong: (name)=> `Not correct, ${name}. Try again.`
  }
};

/* ===================== POOLS ===================== */
// Sad…ô demo: ist…ôyirs…ôn sonra siyahƒ±larƒ± geni≈ül…ôndir…ôk (20 r…ôq…ôm, 50/50/50)
// ƒ∞ndi is…ô stabil i≈ül…ôsin dey…ô orta √∂l√ß√ºd…ô saxladƒ±m:
const NUMBERS = Array.from({length: 20}, (_,i)=> String(i+1));

const FRUITS = ["üçé","üçå","üçá","üçì","üçí","üçë","üçç","ü•≠","üçâ","üçê","üçä","üçã"];
const ANIMALS = ["üê∂","üê±","üê∞","ü¶ä","üêª","üêº","üêØ","ü¶Å","üê∏","üêµ","üê®","üêÆ"];
const OBJECTS = ["üéÅ","üéà","üöó","‚úèÔ∏è","üìò","üéß","‚åö","üß∏","‚öΩ","ü™Å","üß©","üñçÔ∏è"];

function pickCategoryItem(){
  const all = [
    ...NUMBERS.map(x=>({type:"num", val:x})),
    ...FRUITS.map(x=>({type:"fruit", val:x})),
    ...ANIMALS.map(x=>({type:"animal", val:x})),
    ...OBJECTS.map(x=>({type:"obj", val:x}))
  ];
  return all[Math.floor(Math.random()*all.length)];
}

function shuffle(a){
  for(let i=a.length-1;i>0;i--){
    const j=Math.floor(Math.random()*(i+1));
    [a[i],a[j]]=[a[j],a[i]];
  }
  return a;
}

/* ===================== STATE ===================== */
let lang = "az";
let child = "U≈üaq";
let scoreVal = 0;
let correct = null;
let speakingLock = false;
let pendingNext = null;

/* ===================== SPEECH (fallback) ===================== */
function getVoicesSafe(){
  try { return window.speechSynthesis?.getVoices?.() || []; }
  catch { return []; }
}
function pickVoice(lang){
  const voices = getVoicesSafe();
  const prefs = {
    az: ["az", "az-AZ", "tr-TR", "tr"],
    ru: ["ru", "ru-RU"],
    en: ["en-GB", "en", "en-US"]
  }[lang] || ["en"];
  for(const code of prefs){
    const v = voices.find(x => (x.lang||"").toLowerCase().startsWith(code.toLowerCase()));
    if(v) return v;
  }
  return voices[0] || null;
}

function speak(text){
  if(!window.speechSynthesis) return;

  // eyni anda √ºst-√ºst…ô danƒ±≈ümasƒ±n
  window.speechSynthesis.cancel();
  speakingLock = true;

  const u = new SpeechSynthesisUtterance(text);
  u.rate = 0.95;
  u.pitch = 1.05;
  u.lang = ({az:"az-AZ",ru:"ru-RU",en:"en-GB"}[lang] || "en-GB");

  const v = pickVoice(lang);
  if(v) u.voice = v;

  u.onend = () => {
    speakingLock = false;
    if(pendingNext){
      const fn = pendingNext;
      pendingNext = null;
      fn();
    }
  };
  u.onerror = () => { speakingLock = false; };

  // ilk klik t…ôl…ôbi √º√ß√ºn ki√ßik gecikm…ô
  setTimeout(()=>window.speechSynthesis.speak(u), 80);
}

/* ===================== UI HELPERS ===================== */
const $ = (id)=>document.getElementById(id);

function applyLang(){
  const t = I18N[lang];
  $("t_settings").textContent = t.settings;
  $("t_hint").textContent = t.hint;
  $("t_tip").textContent = t.tip;
  $("btnClear").textContent = t.clear;
  $("btnStart").textContent = t.start;
  $("btnNew").textContent = t.new;
  $("btnBack").textContent = t.back;
  $("t_taskLabel").textContent = t.taskLabel;
  $("t_gameTip").textContent = t.gameTip;

  $("flag").textContent = (lang==="az"?"üá¶üáø":lang==="ru"?"üá∑üá∫":"üá¨üáß");
}

function showGame(){
  $("settings").classList.add("hidden");
  $("game").classList.remove("hidden");
}
function showSettings(){
  $("game").classList.add("hidden");
  $("settings").classList.remove("hidden");
}

function setAvatarFromFile(file){
  const img = $("avatarImg");
  const ph = $("avatarBox").querySelector(".ph");
  if(!file){
    img.style.display="none";
    ph.style.display="block";
    img.src="";
    return;
  }
  const reader = new FileReader();
  reader.onload = (e)=>{
    img.src = e.target.result;
    img.style.display="block";
    ph.style.display="none";
  };
  reader.readAsDataURL(file);
}

/* ===================== GAME LOGIC ===================== */
function buildRound(){
  const t = I18N[lang];

  // 1 doƒüru se√ßim
  correct = pickCategoryItem();

  // 3 yanlƒ±≈ü se√ßim (unique)
  const opts = new Map();
  opts.set(correct.val, correct);

  while(opts.size < 4){
    const it = pickCategoryItem();
    if(!opts.has(it.val)) opts.set(it.val, it);
  }

  const arr = shuffle([...opts.values()]);
  const grid = $("grid");
  grid.innerHTML = "";

  arr.forEach(it=>{
    const div = document.createElement("div");
    div.className = "cardItem";
    div.textContent = it.val;
    div.onclick = ()=> onPick(it);
    grid.appendChild(div);
  });

  // tap≈üƒ±rƒ±q ekranda g√∂st…ôrilm…ôsin ‚Äî yalnƒ±z s…ôs
  // ‚ÄúTap: ‚Ä¶‚Äù yazƒ±sƒ±nƒ± gizli saxlayƒ±rƒ±q (label qalƒ±r, amma h…ôd…ôf g√∂r√ºnm√ºr)
  $("childChip").textContent = child ? `‚Ä¢ ${child}` : "";

  // S…ôsi ver
  const targetSpoken = t.sayFind(correct.val);
  speak(targetSpoken);
}

function onPick(it){
  const t = I18N[lang];

  // danƒ±≈üƒ±q gedirs…ô, klikl…ôri bir az blokla (qarƒ±≈üƒ±qlƒ±q olmasƒ±n)
  if(speakingLock) return;

  if(it.val === correct.val){
    scoreVal += 1;
    $("score").textContent = String(scoreVal);

    // …ôvv…ôl ‚ÄúAferin, Ad!‚Äù bitsin, sonra yeni m…ôrh…ôl…ô
    speak(t.bravo(child));
    pendingNext = ()=> setTimeout(buildRound, 250); // ki√ßik pauza
  }else{
    speak(t.wrong(child));
  }
}

function newGame(){
  buildRound();
}

/* ===================== EVENTS ===================== */
$("photoInput").addEventListener("change", (e)=>{
  const file = e.target.files && e.target.files[0];
  setAvatarFromFile(file);
});

$("langSelect").addEventListener("change", (e)=>{
  lang = e.target.value || "az";
  applyLang();
});

$("btnClear").addEventListener("click", ()=>{
  $("childName").value = "";
  $("photoInput").value = "";
  setAvatarFromFile(null);
});

$("btnStart").addEventListener("click", ()=>{
  // lang
  lang = $("langSelect").value || "az";
  applyLang();

  // child name
  child = ($("childName").value || "").trim();
  if(!child) child = (lang==="ru"?"–†–µ–±—ë–Ω–æ–∫":lang==="en"?"Kid":"U≈üaq");

  // reset score
  scoreVal = 0;
  $("score").textContent = "0";

  showGame();
  // ilk toxunu≈ü t…ôl…ôb oluna bil…ôr ‚Äî biz startda da s…ôs veririk
  setTimeout(buildRound, 120);
});

$("btnBack").addEventListener("click", ()=>{
  showSettings();
});

$("btnNew").addEventListener("click", ()=>{
  buildRound();
});

/* voices sometimes load async */
window.speechSynthesis?.addEventListener?.("voiceschanged", ()=>{});

/* init */
applyLang();

/* ===================== PWA ===================== */
if("serviceWorker" in navigator){
  navigator.serviceWorker.register("service-worker.js").catch(()=>{});
}
</script>
</body>
</html>
